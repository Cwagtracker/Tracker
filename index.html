<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dog Trialing Records Tracker - Debug</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .header {
            background: linear-gradient(90deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-text {
            text-align: center;
            flex: 1;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .last-updated {
            opacity: 0.8;
            font-size: 0.95rem;
            font-style: italic;
        }

        .logo {
            width: 160px;
            height: 160px;
            background-image: url('https://raw.githubusercontent.com/cwagtracker/Tracker/main/cwags-logo.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .search-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .search-container {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .search-input {
            padding: 15px 20px;
            font-size: 1.1rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 300px;
            max-width: 100%;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .force-reload-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .force-reload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(220, 53, 69, 0.3);
        }

        .main-content {
            padding: 30px;
        }

        .debug-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .debug-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .debug-info {
            font-family: monospace;
            font-size: 0.9rem;
            color: #212529;
            margin: 5px 0;
        }

        .summary-section {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            width: 100%;
        }

        .section-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .section-content {
            padding: 20px;
        }

        .dog-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .dog-info h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.4rem;
        }

        .dog-info p {
            color: #7f8c8d;
            margin: 5px 0;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .loading-message {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 1.1rem;
        }

        .upload-section {
            text-align: center;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 12px;
            margin: 20px 0;
        }

        .upload-section h3 {
            color: #17a2b8;
            margin-bottom: 20px;
        }

        .file-upload-area {
            background: white;
            padding: 30px;
            border-radius: 12px;
            border: 2px dashed #dee2e6;
            margin: 20px 0;
        }

        .upload-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 15px;
        }

        .upload-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div id="leftLogo" class="logo"></div>
                <div class="header-text">
                    <h1>CWAGS Tracker - Debug Version</h1>
                    <p>Track your dog's trialing progress with debugging info</p>
                    <div class="last-updated" id="lastUpdated">Loading data...</div>
                </div>
                <div id="rightLogo" class="logo"></div>
            </div>
        </div>

        <div class="search-section">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" 
                       placeholder="Enter Registration Number (e.g., 17-1734-06)" 
                       onkeypress="handleKeyPress(event)">
                <button class="search-btn" onclick="searchDog()">Search Dog Records</button>
                <button class="force-reload-btn" onclick="forceReloadData()">üîÑ Force Reload Data</button>
            </div>
        </div>

        <div class="main-content">
            <!-- Debug Information Section -->
            <div class="debug-section">
                <h3>üîç Debug Information</h3>
                <div class="debug-info" id="debugInfo">
                    Initializing debug information...
                </div>
            </div>

            <div class="summary-section">
                <div class="section-header">Points Summary & Title Progress</div>
                <div class="section-content" id="summaryContent">
                    <div class="loading-message">
                        Loading trialing data...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let trialingData = [];
        let currentDogRecords = [];
        let dogInfoData = {};
        let lastLoadTime = null;

        function updateDebugInfo(message) {
            const debugDiv = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            console.log(`[DEBUG] ${message}`);
        }

        function clearDebugInfo() {
            document.getElementById('debugInfo').innerHTML = '';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                searchDog();
            }
        }

        function forceReloadData() {
            updateDebugInfo('üîÑ Force reload initiated by user');
            clearDebugInfo();
            updateDebugInfo('üîÑ Force reload initiated by user');
            
            // Clear any cached data
            trialingData = [];
            currentDogRecords = [];
            
            // Add cache-busting timestamp and random number for extra cache prevention
            const timestamp = new Date().getTime();
            const random = Math.floor(Math.random() * 10000);
            const fileName = `Data for Tracker web.xlsx?t=${timestamp}&r=${random}`;
            
            updateDebugInfo(`üìÅ Attempting to load: ${fileName}`);
            
            fetch(fileName, {
                method: 'GET',
                cache: 'no-cache',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                }
            })
            .then(response => {
                updateDebugInfo(`üì° Server response status: ${response.status}`);
                updateDebugInfo(`üì° Response headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const contentLength = response.headers.get('content-length');
                updateDebugInfo(`üìä File size: ${contentLength ? contentLength + ' bytes' : 'unknown'}`);
                
                return response.arrayBuffer();
            })
            .then(data => {
                updateDebugInfo(`‚úÖ File loaded successfully, processing ${data.byteLength} bytes`);
                processExcelData(new Uint8Array(data));
                updateLastUpdatedDate();
                lastLoadTime = new Date();
                updateDebugInfo(`üéâ Data processing complete! ${trialingData.length} records loaded`);
                
                // Show basic validation info
                if (trialingData.length > 0) {
                    const sampleRecord = trialingData[0];
                    updateDebugInfo(`üìù Sample record: ${JSON.stringify(sampleRecord)}`);
                    
                    const uniqueRegNumbers = [...new Set(trialingData.map(r => r.registrationNumber))];
                    updateDebugInfo(`üêï Unique dogs in data: ${uniqueRegNumbers.length}`);
                    
                    const dateRange = getDataDateRange();
                    updateDebugInfo(`üìÖ Data date range: ${dateRange.earliest} to ${dateRange.latest}`);
                }
                
                showDefaultContent();
            })
            .catch(error => {
                updateDebugInfo(`‚ùå Error loading data: ${error.message}`);
                console.error('Error loading data:', error);
                document.getElementById('lastUpdated').textContent = 'Load failed - see debug info';
                showFileUpload();
            });
        }

        function getDataDateRange() {
            const validDates = trialingData
                .map(record => record.date)
                .filter(date => date instanceof Date && !isNaN(date))
                .sort((a, b) => a - b);

            if (validDates.length === 0) {
                return { earliest: 'N/A', latest: 'N/A' };
            }

            return {
                earliest: validDates[0].toLocaleDateString(),
                latest: validDates[validDates.length - 1].toLocaleDateString()
            };
        }

        function loadDataFromFile() {
            updateDebugInfo('üöÄ Initial data load starting...');
            
            const timeoutId = setTimeout(() => {
                updateDebugInfo('‚è∞ Load timeout (3s) - showing manual upload option');
                showFileUpload();
            }, 3000);

            fetch('Data for Tracker web.xlsx')
                .then(response => {
                    clearTimeout(timeoutId);
                    updateDebugInfo(`üì° Initial fetch response status: ${response.status}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    return response.arrayBuffer();
                })
                .then(data => {
                    updateDebugInfo(`‚úÖ Initial file loaded, size: ${data.byteLength} bytes`);
                    processExcelData(new Uint8Array(data));
                    updateLastUpdatedDate();
                    lastLoadTime = new Date();
                    updateDebugInfo(`üéâ Initial data processing complete! ${trialingData.length} records loaded`);
                    showDefaultContent();
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    updateDebugInfo(`‚ùå Initial load failed: ${error.message}`);
                    console.error('Error loading data:', error);
                    document.getElementById('lastUpdated').textContent = 'File not found - try manual upload';
                    showFileUpload();
                });
        }

        function processExcelData(data) {
            updateDebugInfo('üîÑ Processing Excel data...');
            
            try {
                const workbook = XLSX.read(data, {type: 'array', cellDates: true});
                updateDebugInfo(`üìä Workbook loaded, sheets: ${workbook.SheetNames.join(', ')}`);
                
                // Look for Data sheet
                const dataSheet = workbook.Sheets['Data'] || workbook.Sheets[workbook.SheetNames[0]];
                const sheetName = workbook.Sheets['Data'] ? 'Data' : workbook.SheetNames[0];
                updateDebugInfo(`üìã Using sheet: ${sheetName}`);
                
                const jsonData = XLSX.utils.sheet_to_json(dataSheet, {header: 1, dateNF: 'yyyy-mm-dd'});
                updateDebugInfo(`üìä Raw data rows: ${jsonData.length}`);
                
                if (jsonData.length > 1) {
                    updateDebugInfo(`üìù Headers: ${JSON.stringify(jsonData[0])}`);
                    updateDebugInfo(`üìù Sample row: ${JSON.stringify(jsonData[1])}`);
                }
                
                // Process the data with proper date handling
                trialingData = jsonData.slice(1).map((row, index) => {
                    let processedDate = row[2];
                    
                    // Handle different date formats
                    if (typeof processedDate === 'number') {
                        // Excel date serial number - convert to proper date
                        processedDate = XLSX.SSF.parse_date_code(processedDate);
                        processedDate = new Date(processedDate.y, processedDate.m - 1, processedDate.d);
                    } else if (typeof processedDate === 'string') {
                        // String date - parse it
                        processedDate = new Date(processedDate);
                    } else if (processedDate instanceof Date) {
                        // Already a date object
                        processedDate = processedDate;
                    } else {
                        // Invalid date
                        processedDate = null;
                    }
                    
                    const record = {
                        registrationNumber: row[0],       // Column A
                        callName: row[1],                 // Column B  
                        date: processedDate,              // Column C
                        level: row[3],                    // Column D
                        results: row[4],                  // Column E
                        judge: row[5],                    // Column F
                        points: parseFloat(row[6]) || 0   // Column G
                    };
                    
                    if (index < 5) {
                        updateDebugInfo(`üìù Processed row ${index + 1}: ${JSON.stringify(record)}`);
                    }
                    
                    return record;
                }).filter(record => record.registrationNumber && record.level);
                
                updateDebugInfo(`‚úÖ Filtered data: ${trialingData.length} valid records`);
                
                // Show some data statistics
                const uniqueRegNumbers = [...new Set(trialingData.map(r => r.registrationNumber))];
                const uniqueLevels = [...new Set(trialingData.map(r => r.level))];
                const pointsRecords = trialingData.filter(r => r.points > 0);
                
                updateDebugInfo(`üìä Statistics: ${uniqueRegNumbers.length} dogs, ${uniqueLevels.length} levels, ${pointsRecords.length} qualifying records`);
                
            } catch (error) {
                updateDebugInfo(`‚ùå Error processing Excel data: ${error.message}`);
                throw error;
            }
        }

        function updateLastUpdatedDate() {
            if (trialingData.length === 0) {
                document.getElementById('lastUpdated').textContent = 'No data available';
                return;
            }

            // Find the most recent date in the data
            const validDates = trialingData
                .map(record => record.date)
                .filter(date => date instanceof Date && !isNaN(date))
                .sort((a, b) => b - a);

            if (validDates.length > 0) {
                const mostRecentDate = validDates[0];
                const loadTimeText = lastLoadTime ? ` (loaded at ${lastLoadTime.toLocaleTimeString()})` : '';
                document.getElementById('lastUpdated').textContent = 
                    `Last record: ${mostRecentDate.toLocaleDateString()}${loadTimeText}`;
            } else {
                document.getElementById('lastUpdated').textContent = 'Last updated: Unknown';
            }
        }

        function showDefaultContent() {
            document.getElementById('summaryContent').innerHTML = `
                <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #0c5460; margin-bottom: 10px;">‚úÖ Data Loaded Successfully!</h4>
                    <p style="color: #0c5460; margin: 0;">Ready to search dog records. Enter a registration number above to get started.</p>
                </div>
                
                <div style="background: #e7f3ff; border: 1px solid #b8daff; border-radius: 8px; padding: 15px;">
                    <h4 style="color: #004085; margin-bottom: 10px;">Title Requirements</h4>
                    <ul style="color: #004085; margin-left: 20px;">
                        <li>Minimum 4 points required for each level</li>
                        <li>Points must come from at least 2 different judges</li>
                        <li>Prerequisites must be met before advancing to higher levels</li>
                        <li>Special case: "Investigator 3" requires either "Patrol 1" OR "Detective 2"</li>
                        <li>Games levels require at least 2 different games (BJ, C, P, T, GB)</li>
                        <li>Ace awards given every 10 points after title is earned</li>
                    </ul>
                </div>
            `;
        }

        function showFileUpload() {
            document.getElementById('summaryContent').innerHTML = `
                <div class="upload-section">
                    <h3>üìÅ Upload Data File</h3>
                    <p>The main data file couldn't be loaded automatically. Please upload it manually:</p>
                    
                    <div class="file-upload-area">
                        <input type="file" id="manualDataFile" accept=".xlsx,.xls,.csv" style="margin-bottom: 15px;">
                        <br>
                        <button class="upload-btn" onclick="loadManualFile()">üì§ Load File</button>
                    </div>
                    
                    <button onclick="forceReloadData()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; margin-top: 15px;">
                        ‚Üê Try Auto-Loading Again
                    </button>
                </div>
            `;
        }

        function loadManualFile() {
            const fileInput = document.getElementById('manualDataFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file first');
                return;
            }

            updateDebugInfo(`üì§ Manual file upload: ${file.name} (${file.size} bytes)`);

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    updateDebugInfo(`üìä Manual file read: ${data.byteLength} bytes`);
                    processExcelData(data);
                    updateLastUpdatedDate();
                    lastLoadTime = new Date();
                    updateDebugInfo(`üéâ Manual upload successful! ${trialingData.length} records loaded`);
                    showDefaultContent();
                    alert(`Successfully loaded ${trialingData.length} records!`);
                } catch (error) {
                    updateDebugInfo(`‚ùå Error processing manual file: ${error.message}`);
                    console.error('Error loading manual file:', error);
                    alert(`Error loading file: ${error.message}`);
                }
            };
            
            reader.onerror = function() {
                updateDebugInfo(`‚ùå File reader error`);
                alert('Error reading file. Please try again.');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function formatRegistrationNumber(input) {
            if (!input) return '';
            
            // Remove any non-digits and dashes
            let cleaned = input.replace(/[^0-9-]/g, '');
            
            // If input has dashes, work with parts
            if (cleaned.includes('-')) {
                let parts = cleaned.split('-');
                if (parts.length === 3) {
                    // Format as XX-XXXX-XX with leading zeros
                    let part1 = parts[0].padStart(2, '0').substring(0, 2);
                    let part2 = parts[1].padStart(4, '0').substring(0, 4);
                    let part3 = parts[2].padStart(2, '0').substring(0, 2);
                    return `${part1}-${part2}-${part3}`;
                }
            }
            
            // If no dashes but enough digits, auto-format
            const digitsOnly = cleaned.replace(/-/g, '');
            if (digitsOnly.length >= 6) {
                const part1 = digitsOnly.substring(0, 2).padStart(2, '0');
                const part2 = digitsOnly.substring(2, 6).padStart(4, '0');
                const part3 = digitsOnly.substring(6, 8).padStart(2, '0');
                return `${part1}-${part2}-${part3}`;
            }
            
            return cleaned;
        }

        function searchDog() {
            const searchInput = document.getElementById('searchInput').value.trim();
            if (!searchInput) {
                alert('Please enter a registration number');
                return;
            }

            if (trialingData.length === 0) {
                alert('Please wait for trialing data to load or upload a file');
                return;
            }

            updateDebugInfo(`üîç Searching for: "${searchInput}"`);

            // Format the search input
            const formattedSearch = formatRegistrationNumber(searchInput);
            updateDebugInfo(`üîç Formatted search: "${formattedSearch}"`);
            
            // Find exact matching records only
            const dogRecords = trialingData.filter(record => 
                record.registrationNumber && 
                record.registrationNumber.toLowerCase() === formattedSearch.toLowerCase()
            );

            updateDebugInfo(`üîç Found ${dogRecords.length} matching records`);

            if (dogRecords.length === 0) {
                // If no exact match, show suggestion with partial matches
                const partialMatches = trialingData.filter(record =>
                    record.registrationNumber && 
                    record.registrationNumber.toLowerCase().includes(formattedSearch.toLowerCase())
                ).slice(0, 5);

                updateDebugInfo(`üîç Found ${partialMatches.length} partial matches`);

                let errorMessage = `No dog found with registration number: <strong>${formattedSearch}</strong>`;
                
                if (partialMatches.length > 0) {
                    errorMessage += '<br><br><strong>Did you mean:</strong><ul style="text-align: left; margin: 10px 0;">';
                    partialMatches.forEach(match => {
                        errorMessage += `<li><a href="#" onclick="searchSpecific('${match.registrationNumber}')" style="color: #007bff; text-decoration: underline;">${match.registrationNumber} (${match.callName || 'Unknown'})</a></li>`;
                    });
                    errorMessage += '</ul>';
                }

                document.getElementById('summaryContent').innerHTML = 
                    `<div class="error-message">${errorMessage}</div>`;
                return;
            }

            // Store records globally for modal access
            currentDogRecords = dogRecords;
            displayBasicSummary(dogRecords);
        }

        function searchSpecific(regNumber) {
            document.getElementById('searchInput').value = regNumber;
            searchDog();
        }

        function displayBasicSummary(records) {
            const regNumber = records[0].registrationNumber;
            const callName = records[0].callName || 'Unknown';
            
            updateDebugInfo(`üìä Displaying summary for ${callName} (${regNumber})`);
            
            const levelSummary = {};
            
            // Group records by level
            records.forEach(record => {
                if (!record.level) return;
                
                if (!levelSummary[record.level]) {
                    levelSummary[record.level] = {
                        totalPoints: 0,
                        judges: new Set(),
                        records: []
                    };
                }
                
                if (record.points > 0) {
                    levelSummary[record.level].totalPoints += record.points;
                    if (record.judge) {
                        levelSummary[record.level].judges.add(record.judge);
                    }
                }
                levelSummary[record.level].records.push(record);
            });

            updateDebugInfo(`üìä Level summary calculated for ${Object.keys(levelSummary).length} levels`);

            let html = `
                <div class="dog-info">
                    <h3>${callName}</h3>
                    <p><strong>Registration:</strong> ${regNumber}</p>
                    <p><strong>Total Trialing Records:</strong> ${records.length}</p>
                </div>
            `;
            
            Object.keys(levelSummary).forEach(level => {
                const summary = levelSummary[level];
                const judgeCount = summary.judges.size;
                const hasTitleRequirements = summary.totalPoints >= 4 && judgeCount >= 2;
                
                html += `
                    <div style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">${level}</h4>
                        <div style="font-size: 0.9rem;">
                            <div><span>Total Points:</span> <strong>${summary.totalPoints}</strong></div>
                            <div><span>Judges:</span> <strong>${judgeCount}/2</strong></div>
                            <div><span>Status:</span> <strong style="color: ${hasTitleRequirements ? '#28a745' : '#dc3545'};">
                                ${hasTitleRequirements ? 'Title Requirements Met!' : 'Working Toward Title'}
                            </strong></div>
                            ${!hasTitleRequirements ? `
                                <div style="color: #dc3545; margin-top: 5px;">
                                    Need: ${summary.totalPoints < 4 ? `${4 - summary.totalPoints} more points` : ''}
                                    ${summary.totalPoints < 4 && judgeCount < 2 ? ', ' : ''}
                                    ${judgeCount < 2 ? `${2 - judgeCount} more judge${judgeCount === 0 ? 's' : ''}` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            document.getElementById('summaryContent').innerHTML = html || '<div class="error-message">No level data to display</div>';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateDebugInfo('üöÄ CWAGS Tracker Debug Version initializing...');
            document.getElementById('lastUpdated').textContent = 'Loading data...';
            
            setTimeout(() => {
                loadDataFromFile();
            }, 500);
        });
    </script>
</body>
</html>
