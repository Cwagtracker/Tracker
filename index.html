<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dog Trialing Records Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }

        .header {
            background: linear-gradient(90deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-text {
            text-align: center;
            flex: 1;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .last-updated {
            opacity: 0.8;
            font-size: 0.95rem;
            font-style: italic;
        }

        .logo {
            width: 160px;
            height: 160px;
            background-image: url('cwags-logo.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .search-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .search-container {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .search-input {
            padding: 15px 20px;
            font-size: 1.1rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 300px;
            max-width: 100%;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .owner-view-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .main-content {
            padding: 30px;
        }

        .summary-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            overflow: hidden;
            width: 100%;
        }

        .section-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .section-content {
            padding: 20px;
        }

        .dog-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .dog-info h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.4rem;
        }

        .dog-info p {
            color: #7f8c8d;
            margin: 5px 0;
        }

        .level-summary {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: start;
        }

        .level-info {
            flex: 1;
        }

        .level-summary h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title-status {
            font-size: 0.9rem;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .title-earned {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .no-title {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .points-breakdown {
            font-size: 0.9rem;
            margin: 8px 0;
        }

        .points-breakdown div {
            margin: 4px 0;
            display: flex;
            justify-content: space-between;
        }

        .ace-info {
            color: #6f42c1;
            font-weight: 600;
        }

        .details-btn {
            background: linear-gradient(45deg, #17a2b8, #20c997);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            align-self: start;
        }

        .details-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
        }

        .certificate-btn {
            background: linear-gradient(45deg, #6f42c1, #8e44ad);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            align-self: start;
            margin-top: 8px;
        }

        .certificate-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(111, 66, 193, 0.3);
        }

        .certificate-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .certificate-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .validation-rules {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .validation-rules h4 {
            color: #004085;
            margin-bottom: 10px;
        }

        .validation-rules ul {
            margin-left: 20px;
        }

        .validation-rules li {
            color: #004085;
            margin: 5px 0;
            font-size: 0.9rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.4rem;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .loading-message {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 1.1rem;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .records-table th,
        .records-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9rem;
        }

        .records-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .records-table tr:hover {
            background: #f8f9fa;
        }

        .points-badge {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .points-badge.zero {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div id="leftLogo" class="logo"></div>
                <div class="header-text">
                    <h1>CWAGS Tracker</h1>
                    <p>Track your dog's trialing progress, Q's, and title eligibility</p>
                    <div class="last-updated" id="lastUpdated">Loading data...</div>
                </div>
                <div id="rightLogo" class="logo"></div>
            </div>
        </div>

        <div class="search-section">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" 
                       placeholder="Enter Registration Number (e.g., 17-1734-06)" 
                       onkeypress="handleKeyPress(event)">
                <button class="search-btn" onclick="searchDog()">Search Dog Records</button>
                <button class="owner-view-btn" onclick="showOwnerView()">Owner View by ID</button>
                <small style="color: #666; font-size: 0.8rem;">v4.2 - Certificate System Fixed!</small>
            </div>
        </div>

        <div class="main-content">
            <div class="summary-section">
                <div class="section-header">Q's Summary & Title Progress</div>
                <div class="section-content" id="summaryContent">
                    <div class="loading-message">
                        Loading trialing data...
                    </div>
                    <div class="validation-rules">
                        <h4>Title Requirements</h4>
                        <ul>
                            <li>Minimum 4 Q's required for each level</li>
                            <li>Q's must come from at least 2 different judges</li>
                            <li>Prerequisites must be met before advancing to higher levels</li>
                            <li>Special case: "Investigator 3" requires either "Patrol 1" OR "Detective 2"</li>
                            <li>Games levels require at least 2 different games (BJ, C, P, T, GB)</li>
                            <li>Ace awards given every 10 Q's after title is earned</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal for showing detailed records -->
        <div id="detailsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">Level Details</h2>
                    <span class="close" onclick="closeModal()">&times;</span>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script>
        let trialingData = [];
        let currentDogRecords = [];
        
        // Official title abbreviations
        const titleAbbreviations = {
            "Patrol 1": "CW-SP",
            "Detective 2": "CW-SD",
            "Investigator 3": "CW-SI",
            "Super Sleuth 4": "CW-SS",
            "Private Inv": "CW-SPI",
            "Det Diversions": "CW-SDD",
            "Ranger 1": "CW-ScR1",
            "Ranger 2": "CW-ScR2",
            "Ranger 3": "CW-ScR3",
            "Ranger 4": "CW-ScR4",
            "Ranger 5": "CW-ScR5",
            "Dasher 3": "CW-SD3",
            "Dasher 4": "CW-SD4",
            "Dasher 5": "CW-SD5",
            "Dasher 6": "CW-SD6",
            "Obedience 1": "CW-Ob1",
            "Obedience 2": "CW-Ob2",
            "Obedience 3": "CW-Ob3",
            "Obedience 4": "CW-Ob4",
            "Obedience 5": "CW-Ob5",
            "Starter": "CW-SR",
            "Advanced": "CW-AR",
            "Pro": "CW-PR",
            "ARF": "CW-ARF",
            "Zoom 1": "CW-ZR1",
            "Zoom 1.5": "CW-ZR1.5",
            "Zoom 2": "CW-ZR2",
            "Games 1": "CW-G1",
            "Games 2": "CW-G2",
            "Games 3": "CW-G3",
            "Games 4": "CW-G4"
        };

        // Level prerequisites mapping
        const prerequisites = {
            "Investigator 3": ["Patrol 1", "Detective 2"],
            "Super Sleuth 4": ["Investigator 3"],
            "Private Inv": ["Super Sleuth 4"],
            "Det Diversions": ["Super Sleuth 4"],
            "Ranger 2": ["Ranger 1"],
            "Ranger 3": ["Ranger 2"],
            "Ranger 4": ["Ranger 3"],
            "Ranger 5": ["Ranger 4"],
            "Dasher 4": ["Dasher 3"],
            "Dasher 5": ["Dasher 4"],
            "Dasher 6": ["Dasher 5"],
            "Obedience 4": ["Obedience 3"],
            "Obedience 5": ["Obedience 4"]
        };

        // Proper level ordering
        const levelOrder = [
            "Patrol 1", "Detective 2", "Investigator 3", "Super Sleuth 4", "Private Inv", "Det Diversions",
            "Ranger 1", "Ranger 2", "Ranger 3", "Ranger 4", "Ranger 5",
            "Dasher 3", "Dasher 4", "Dasher 5", "Dasher 6",
            "Obedience 1", "Obedience 2", "Obedience 3", "Obedience 4", "Obedience 5",
            "Starter", "Advanced", "Pro", "ARF",
            "Zoom 1", "Zoom 1.5", "Zoom 2",
            "Games 1", "Games 2", "Games 3", "Games 4"
        ];

        // Certificate template mapping - maps levels to their template files
        const certificateTemplateMapping = {
            // Scent Work titles use Scent.pdf
            'Patrol 1': { template: 'Scent.pdf', category: 'scent' },
            'Detective 2': { template: 'Scent.pdf', category: 'scent' },
            'Investigator 3': { template: 'Scent.pdf', category: 'scent' },
            'Super Sleuth 4': { template: 'Scent.pdf', category: 'scent' },
            'Private Inv': { template: 'Scent.pdf', category: 'scent' },
            'Det Diversions': { template: 'Scent.pdf', category: 'scent' },
            'Ranger 1': { template: 'Scent.pdf', category: 'scent' },
            'Ranger 2': { template: 'Scent.pdf', category: 'scent' },
            'Ranger 3': { template: 'Scent.pdf', category: 'scent' },
            'Ranger 4': { template: 'Scent.pdf', category: 'scent' },
            'Ranger 5': { template: 'Scent.pdf', category: 'scent' },
            'Dasher 3': { template: 'Scent.pdf', category: 'scent' },
            'Dasher 4': { template: 'Scent.pdf', category: 'scent' },
            'Dasher 5': { template: 'Scent.pdf', category: 'scent' },
            'Dasher 6': { template: 'Scent.pdf', category: 'scent' },
            
            // Obedience titles use Obedience.pdf
            'Obedience 1': { template: 'Obedience.pdf', category: 'obedience' },
            'Obedience 2': { template: 'Obedience.pdf', category: 'obedience' },
            'Obedience 3': { template: 'Obedience.pdf', category: 'obedience' },
            'Obedience 4': { template: 'Obedience.pdf', category: 'obedience' },
            'Obedience 5': { template: 'Obedience.pdf', category: 'obedience' },
            
            // Rally titles use Rally.pdf
            'Starter': { template: 'Rally.pdf', category: 'rally' },
            'Advanced': { template: 'Rally.pdf', category: 'rally' },
            'Pro': { template: 'Rally.pdf', category: 'rally' },
            'ARF': { template: 'Rally.pdf', category: 'rally' },
            'Zoom 1': { template: 'Rally.pdf', category: 'rally' },
            'Zoom 1.5': { template: 'Rally.pdf', category: 'rally' },
            'Zoom 2': { template: 'Rally.pdf', category: 'rally' },
            
            // Games titles use Games.pdf
            'Games 1': { template: 'Games.pdf', category: 'games' },
            'Games 2': { template: 'Games.pdf', category: 'games' },
            'Games 3': { template: 'Games.pdf', category: 'games' },
            'Games 4': { template: 'Games.pdf', category: 'games' }
        };

        // Font and positioning configuration for title certificates (8.5x11 landscape = 792x612)
        const titleCertificateConfig = {
            // Registration number positioning (top left area)
            registrationNumber: {
                x: 50,   // Left margin
                y: 570,  // Near top (landscape orientation)
                size: 12,
                color: [0, 0, 0] // Black
            },
            
            // Dog name positioning (center area) 
            dogName: {
                x: 396,  // Center X (792/2)
                y: 400,  // Center area
                size: 28,
                color: [0, 0, 0], // Black
                align: 'center'
            },
            
            // Date positioning 
            dateEarned: {
                x: 150,  // Left side of sentence area
                y: 250,  // Lower area
                size: 12,
                color: [0, 0, 0] // Black
            },
            
            // Title abbreviation positioning (prominent display)
            titleAbbreviation: {
                x: 396,  // Center X
                y: 180,  // Below other text
                size: 24,
                color: [0, 0, 0.5], // Navy blue
                align: 'center',
                weight: 'bold'
            }
        };

        async function generateTitleCertificate(level, regNumber, dogName, abbreviation) {
            try {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Generating...';
                btn.disabled = true;

                // Get template info
                const templateInfo = certificateTemplateMapping[level];
                if (!templateInfo) {
                    throw new Error(`No certificate template mapped for level: ${level}`);
                }

                // Get dog's records for this level
                const levelRecords = trialingData.filter(r => 
                    r.registrationNumber === regNumber && r.level === level
                );

                if (levelRecords.length === 0) {
                    throw new Error('No records found for this level');
                }

                // Calculate date earned
                const titleInfo = calculateTitlePoints(levelRecords);
                const dateEarned = titleInfo.titleDate ? titleInfo.titleDate.toLocaleDateString() : new Date().toLocaleDateString();

                // Load the template from GitHub repository
                const templateUrl = `https://raw.githubusercontent.com/cwagtracker/Tracker/main/templates/${templateInfo.template}`;
                
                let templateBytes;
                try {
                    const response = await fetch(templateUrl);
                    if (!response.ok) {
                        throw new Error(`Template not found: ${templateUrl}`);
                    }
                    templateBytes = await response.arrayBuffer();
                } catch (fetchError) {
                    // Fallback to creating a basic certificate if template not available
                    console.warn('Template not available, creating basic certificate:', fetchError);
                    return await createFallbackCertificate(dogName, regNumber, level, abbreviation, dateEarned);
                }

                // Load the template PDF
                const pdfDoc = await PDFLib.PDFDocument.load(templateBytes);
                const pages = pdfDoc.getPages();
                const firstPage = pages[0];
                
                // Embed fonts
                const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                const boldFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);

                // Add registration number
                const regConfig = titleCertificateConfig.registrationNumber;
                firstPage.drawText(regNumber, {
                    x: regConfig.x,
                    y: regConfig.y,
                    size: regConfig.size,
                    font: font,
                    color: PDFLib.rgb(regConfig.color[0], regConfig.color[1], regConfig.color[2])
                });

                // Add dog name (centered)
                const dogConfig = titleCertificateConfig.dogName;
                const dogTextWidth = font.widthOfTextAtSize(dogName, dogConfig.size);
                const dogX = dogConfig.align === 'center' ? dogConfig.x - (dogTextWidth / 2) : dogConfig.x;
                
                firstPage.drawText(dogName, {
                    x: dogX,
                    y: dogConfig.y,
                    size: dogConfig.size,
                    font: boldFont,
                    color: PDFLib.rgb(dogConfig.color[0], dogConfig.color[1], dogConfig.color[2])
                });

                // Add date earned
                const dateConfig = titleCertificateConfig.dateEarned;
                firstPage.drawText(dateEarned, {
                    x: dateConfig.x,
                    y: dateConfig.y,
                    size: dateConfig.size,
                    font: font,
                    color: PDFLib.rgb(dateConfig.color[0], dateConfig.color[1], dateConfig.color[2])
                });

                // Add title abbreviation (centered, bold, navy blue)
                const titleConfig = titleCertificateConfig.titleAbbreviation;
                const titleTextWidth = boldFont.widthOfTextAtSize(abbreviation, titleConfig.size);
                const titleX = titleConfig.align === 'center' ? titleConfig.x - (titleTextWidth / 2) : titleConfig.x;
                
                firstPage.drawText(abbreviation, {
                    x: titleX,
                    y: titleConfig.y,
                    size: titleConfig.size,
                    font: boldFont,
                    color: PDFLib.rgb(titleConfig.color[0], titleConfig.color[1], titleConfig.color[2])
                });

                // Save and download
                const pdfBytes = await pdfDoc.save();
                downloadPDF(pdfBytes, `${dogName}-${level.replace(/\s+/g, '-')}-Title-Certificate.pdf`);

                btn.textContent = originalText;
                btn.disabled = false;

            } catch (error) {
                console.error('Certificate generation error:', error);
                alert(`Unable to generate certificate: ${error.message}\n\nPlease check that the certificate templates are available in your GitHub repository.`);
                
                const btn = event.target;
                btn.textContent = 'üìú Title Certificate';
                btn.disabled = false;
            }
        }

        // Fallback function to create basic certificate if template isn't available
        async function createFallbackCertificate(dogName, regNumber, level, abbreviation, dateEarned) {
            const pdfDoc = await PDFLib.PDFDocument.create();
            const page = pdfDoc.addPage([792, 612]); // Landscape 8.5x11
            const { width, height } = page.getSize();

            const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
            const boldFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);

            // Header
            page.drawText('C-WAGS TITLE CERTIFICATE', {
                x: width / 2 - 120,
                y: height - 80,
                size: 20,
                font: boldFont,
                color: PDFLib.rgb(0, 0, 0.5)
            });

            // Dog name
            page.drawText(dogName, {
                x: width / 2 - (dogName.length * 8),
                y: height - 200,
                size: 28,
                font: boldFont,
                color: PDFLib.rgb(0, 0, 0)
            });

            // Level and abbreviation
            page.drawText(`${level} (${abbreviation})`, {
                x: width / 2 - 80,
                y: height - 300,
                size: 20,
                font: boldFont,
                color: PDFLib.rgb(0, 0, 0.5)
            });

            // Registration and date
            page.drawText(`Registration: ${regNumber}`, { x: 50, y: height - 400, size: 12, font: font });
            page.drawText(`Date Earned: ${dateEarned}`, { x: 50, y: height - 420, size: 12, font: font });

            const pdfBytes = await pdfDoc.save();
            downloadPDF(pdfBytes, `${dogName}-${level.replace(/\s+/g, '-')}-Title-Certificate.pdf`);
        }

        async function generateAceCertificate(level, regNumber, dogName, aceCount) {
            try {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Generating...';
                btn.disabled = true;

                const abbreviation = titleAbbreviations[level] || level;
                const aceDesignation = aceCount === 1 ? `${abbreviation}A` : `${abbreviation}Ax${aceCount}`;

                // Get template info (Ace certificates use the same templates as titles)
                const templateInfo = certificateTemplateMapping[level];
                if (!templateInfo) {
                    throw new Error(`No certificate template mapped for level: ${level}`);
                }

                // Load the template from GitHub repository
                const templateUrl = `https://raw.githubusercontent.com/cwagtracker/Tracker/main/templates/${templateInfo.template}`;
                
                let templateBytes;
                try {
                    const response = await fetch(templateUrl);
                    if (!response.ok) {
                        throw new Error(`Template not found: ${templateUrl}`);
                    }
                    templateBytes = await response.arrayBuffer();
                } catch (fetchError) {
                    // Fallback to creating a basic ace certificate
                    console.warn('Template not available, creating basic ace certificate:', fetchError);
                    return await createFallbackAceCertificate(dogName, regNumber, level, aceDesignation, aceCount);
                }

                // Load the template PDF
                const pdfDoc = await PDFLib.PDFDocument.load(templateBytes);
                const pages = pdfDoc.getPages();
                const firstPage = pages[0];
                
                // Embed fonts
                const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                const boldFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);

                // Add registration number (smaller/less prominent for Ace)
                firstPage.drawText(regNumber, {
                    x: 50,
                    y: 570,
                    size: 10,
                    font: font,
                    color: PDFLib.rgb(0.5, 0.5, 0.5) // Gray
                });

                // Add dog name (centered, same as title)
                const dogTextWidth = boldFont.widthOfTextAtSize(dogName, 28);
                firstPage.drawText(dogName, {
                    x: 396 - (dogTextWidth / 2), // Center in landscape
                    y: 420,
                    size: 28,
                    font: boldFont,
                    color: PDFLib.rgb(0, 0, 0)
                });

                // Add "ACE AWARD" text
                const aceText = 'ACE AWARD';
                const aceTextWidth = boldFont.widthOfTextAtSize(aceText, 20);
                firstPage.drawText(aceText, {
                    x: 396 - (aceTextWidth / 2),
                    y: 350,
                    size: 20,
                    font: boldFont,
                    color: PDFLib.rgb(0.6, 0.2, 0.8) // Purple
                });

                // Add ace designation (prominent, purple)
                const aceDesignationWidth = boldFont.widthOfTextAtSize(aceDesignation, 32);
                firstPage.drawText(aceDesignation, {
                    x: 396 - (aceDesignationWidth / 2),
                    y: 280,
                    size: 32,
                    font: boldFont,
                    color: PDFLib.rgb(0.6, 0.2, 0.8) // Purple
                });

                // Add achievement note
                const achievementText = `${aceCount} Ace Award${aceCount > 1 ? 's' : ''} in ${level}`;
                const achievementWidth = font.widthOfTextAtSize(achievementText, 14);
                firstPage.drawText(achievementText, {
                    x: 396 - (achievementWidth / 2),
                    y: 220,
                    size: 14,
                    font: font,
                    color: PDFLib.rgb(0, 0, 0)
                });

                // Save and download
                const pdfBytes = await pdfDoc.save();
                downloadPDF(pdfBytes, `${dogName}-${level.replace(/\s+/g, '-')}-Ace-Certificate.pdf`);

                btn.textContent = originalText;
                btn.disabled = false;

            } catch (error) {
                console.error('Ace certificate generation error:', error);
                alert(`Unable to generate ace certificate: ${error.message}\n\nPlease check that the certificate templates are available in your GitHub repository.`);
                
                const btn = event.target;
                btn.textContent = 'üèÜ Ace Certificate';
                btn.disabled = false;
            }
        }

        // Fallback function for Ace certificates
        async function createFallbackAceCertificate(dogName, regNumber, level, aceDesignation, aceCount) {
            const pdfDoc = await PDFLib.PDFDocument.create();
            const page = pdfDoc.addPage([792, 612]); // Landscape 8.5x11
            const { width, height } = page.getSize();

            const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
            const boldFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);

            // Header
            page.drawText('C-WAGS ACE CERTIFICATE', {
                x: width / 2 - 100,
                y: height - 80,
                size: 20,
                font: boldFont,
                color: PDFLib.rgb(0.6, 0.2, 0.8)
            });

            // Dog name
            page.drawText(dogName, {
                x: width / 2 - (dogName.length * 8),
                y: height - 180,
                size: 28,
                font: boldFont,
                color: PDFLib.rgb(0, 0, 0)
            });

            // Ace designation
            page.drawText(aceDesignation, {
                x: width / 2 - (aceDesignation.length * 10),
                y: height - 260,
                size: 32,
                font: boldFont,
                color: PDFLib.rgb(0.6, 0.2, 0.8)
            });

            // Achievement text
            page.drawText(`Has achieved ${aceCount} Ace award${aceCount > 1 ? 's' : ''} in ${level}`, {
                x: width / 2 - 120,
                y: height - 340,
                size: 16,
                font: font,
                color: PDFLib.rgb(0, 0, 0)
            });

            // Registration
            page.drawText(`Registration: ${regNumber}`, { x: 50, y: height - 450, size: 12, font: font });

            const pdfBytes = await pdfDoc.save();
            downloadPDF(pdfBytes, `${dogName}-${level.replace(/\s+/g, '-')}-Ace-Certificate.pdf`);
        }

        function downloadPDF(pdfBytes, filename) {
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        function showOwnerView() {
            if (trialingData.length === 0) {
                alert('Please wait for trialing data to load');
                return;
            }

            document.getElementById('summaryContent').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h3 style="color: #17a2b8; margin-bottom: 20px;">üë§ Owner View</h3>
                    <p style="margin-bottom: 20px;">Enter the middle 4 digits from your registration number:</p>
                    
                    <div style="background: #f8f9fa; padding: 30px; border-radius: 12px; border: 2px solid #dee2e6; margin: 20px 0;">
                        <input type="text" id="ownerIdInput" placeholder="e.g., 1734" 
                               style="padding: 15px 20px; font-size: 1.2rem; border: 2px solid #ddd; border-radius: 10px; width: 200px; text-align: center;"
                               onkeypress="handleOwnerKeyPress(event)" maxlength="4">
                        <br><br>
                        <button onclick="loadOwnerView()" style="background: #28a745; color: white; border: none; padding: 15px 30px; border-radius: 10px; cursor: pointer; font-size: 1.1rem;">
                            üìä Load Owner View
                        </button>
                    </div>
                    
                    <button onclick="backToSearch()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                        ‚Üê Back to Search
                    </button>
                </div>
            `;
        }

        function handleOwnerKeyPress(event) {
            if (event.key === 'Enter') {
                loadOwnerView();
            }
        }

        function loadOwnerView() {
            const ownerIdInput = document.getElementById('ownerIdInput');
            if (!ownerIdInput) {
                console.error('Owner ID input not found');
                return;
            }
            
            const ownerId = ownerIdInput.value.trim();
            
            if (!ownerId) {
                alert('Please enter the middle 4 digits');
                return;
            }

            if (!/^\d{4}$/.test(ownerId)) {
                alert('Please enter exactly 4 digits');
                return;
            }

            // Simple implementation for demo
            alert(`Owner view functionality loaded for ID: ${ownerId}`);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                searchDog();
            }
        }

        function backToSearch() {
            document.getElementById('summaryContent').innerHTML = `
                <div class="validation-rules">
                    <h4>Title Requirements</h4>
                    <ul>
                        <li>Minimum 4 Q's required for each level</li>
                        <li>Q's must come from at least 2 different judges</li>
                        <li>Prerequisites must be met before advancing to higher levels</li>
                        <li>Special case: "Investigator 3" requires either "Patrol 1" OR "Detective 2"</li>
                        <li>Games levels require at least 2 different games (BJ, C, P, T, GB)</li>
                        <li>Ace awards given every 10 Q's after title is earned</li>
                    </ul>
                </div>
            `;
        }

        function searchDog() {
            const searchInput = document.getElementById('searchInput').value.trim();
            if (!searchInput) {
                alert('Please enter a registration number');
                return;
            }

            if (trialingData.length === 0) {
                alert('Please wait for trialing data to load');
                return;
            }

            const formattedSearch = formatRegistrationNumber(searchInput);
            const dogRecords = trialingData.filter(record => 
                record.registrationNumber && 
                record.registrationNumber.toLowerCase() === formattedSearch.toLowerCase()
            );

            if (dogRecords.length === 0) {
                document.getElementById('summaryContent').innerHTML = 
                    `<div class="error-message">No dog found with registration number: <strong>${formattedSearch}</strong></div>`;
                return;
            }

            currentDogRecords = dogRecords;
            displaySummary(dogRecords);
        }

        function formatRegistrationNumber(input) {
            if (!input) return '';
            
            let cleaned = input.replace(/[^0-9-]/g, '');
            
            if (cleaned.includes('-')) {
                let parts = cleaned.split('-');
                if (parts.length === 3) {
                    let part1 = parts[0].padStart(2, '0').substring(0, 2);
                    let part2 = parts[1].padStart(4, '0').substring(0, 4);
                    let part3 = parts[2].padStart(2, '0').substring(0, 2);
                    return `${part1}-${part2}-${part3}`;
                }
            }
            
            const digitsOnly = cleaned.replace(/-/g, '');
            if (digitsOnly.length >= 6) {
                const part1 = digitsOnly.substring(0, 2).padStart(2, '0');
                const part2 = digitsOnly.substring(2, 6).padStart(4, '0');
                const part3 = digitsOnly.substring(6, 8).padStart(2, '0');
                return `${part1}-${part2}-${part3}`;
            }
            
            return cleaned;
        }

        function displaySummary(records) {
            const dogName = records[0].callName || 'Unknown';
            const regNumber = records[0].registrationNumber;
            
            const levelSummary = {};
            
            records.forEach(record => {
                if (!record.level) return;
                
                if (!levelSummary[record.level]) {
                    levelSummary[record.level] = {
                        totalPoints: 0,
                        judges: new Set(),
                        records: []
                    };
                }
                
                if (record.points > 0) {
                    levelSummary[record.level].totalPoints += record.points;
                    if (record.judge) {
                        levelSummary[record.level].judges.add(record.judge);
                    }
                }
                levelSummary[record.level].records.push(record);
            });

            let html = `
                <div class="dog-info">
                    <h3>${dogName}</h3>
                    <p><strong>Registration:</strong> ${regNumber}</p>
                    <p><strong>Total Trialing Records:</strong> ${records.length}</p>
                </div>
            `;
            
            getSortedLevels(levelSummary).forEach(level => {
                const summary = levelSummary[level];
                const judgeCount = summary.judges.size;
                
                const hasTitleRequirements = summary.totalPoints >= 4 && judgeCount >= 2;
                
                let titlePoints = 0;
                let acePoints = 0;
                let titleStatus = '';
                let titleClass = '';
                
                if (hasTitleRequirements) {
                    const titleInfo = calculateTitlePoints(summary.records);
                    titlePoints = titleInfo.titlePoints;
                    acePoints = Math.max(0, summary.totalPoints - titlePoints);
                    
                    const officialTitle = titleAbbreviations[level] || level;
                    
                    if (acePoints >= 10) {
                        const aceCount = Math.floor(acePoints / 10);
                        titleStatus = aceCount === 1 ? `${officialTitle}A` : `${officialTitle}Ax${aceCount}`;
                        titleClass = 'title-earned';
                    } else {
                        titleStatus = `${officialTitle} Title Earned`;
                        titleClass = 'title-earned';
                    }
                } else {
                    titleStatus = 'No Title Yet';
                    titleClass = 'no-title';
                }
                
                // Generate certificate buttons
                let certificateButtons = '';
                if (hasTitleRequirements) {
                    const officialTitle = titleAbbreviations[level] || level;
                    
                    // Title certificate button
                    certificateButtons += `
                        <button class="certificate-btn" onclick="generateTitleCertificate('${level}', '${regNumber}', '${dogName}', '${officialTitle}')">
                            üìú Title Certificate
                        </button>
                    `;
                    
                    // Ace certificate button (if applicable)
                    if (acePoints >= 10) {
                        const aceCount = Math.floor(acePoints / 10);
                        certificateButtons += `
                            <button class="certificate-btn" onclick="generateAceCertificate('${level}', '${regNumber}', '${dogName}', ${aceCount})">
                                üèÜ Ace Certificate
                            </button>
                        `;
                    }
                }

                html += `
                    <div class="level-summary">
                        <div class="level-info">
                            <h4>${level}</h4>
                            <div class="title-status ${titleClass}">${titleStatus}</div>
                            
                            <div class="points-breakdown">
                                <div><span>Total Q's:</span> <strong>${summary.totalPoints}</strong></div>
                                <div><span>Judges:</span> <strong>${judgeCount}/2</strong></div>
                                ${hasTitleRequirements ? `
                                    <div><span>Q's Towards Title:</span> <strong>${titlePoints}</strong></div>
                                    <div><span>Q's Towards Ace:</span> <strong class="ace-info">${acePoints}</strong></div>
                                    ${acePoints >= 0 ? `<div class="ace-info"><span>Q's until next Ace:</span> <strong>${10 - (acePoints % 10)}</strong></div>` : ''}
                                ` : `
                                    <div style="color: #dc3545;">
                                        <div><span>Need:</span> ${summary.totalPoints < 4 ? `${4 - summary.totalPoints} more Q's` : ''}
                                        ${summary.totalPoints < 4 && judgeCount < 2 ? ', ' : ''}
                                        ${judgeCount < 2 ? `${2 - judgeCount} more judge${judgeCount === 0 ? 's' : ''}` : ''}</div>
                                    </div>
                                `}
                            </div>
                        </div>
                        <div class="certificate-controls">
                            <button class="details-btn" onclick="showLevelDetails('${level}', '${dogName}')">Details</button>
                            ${certificateButtons}
                        </div>
                    </div>
                `;
            });

            document.getElementById('summaryContent').innerHTML = html || '<div class="error-message">No level data to display</div>';
        }

        function getSortedLevels(levelSummary) {
            const availableLevels = Object.keys(levelSummary);
            const orderedLevels = levelOrder.filter(level => availableLevels.includes(level));
            const unorderedLevels = availableLevels.filter(level => !levelOrder.includes(level));
            return [...orderedLevels, ...unorderedLevels.sort()];
        }

        function calculateTitlePoints(records) {
            const sortedRecords = records
                .filter(r => r.points > 0 && r.date instanceof Date && !isNaN(r.date))
                .sort((a, b) => a.date - b.date);
            
            let cumulativePoints = 0;
            let judges = new Set();
            
            for (const record of sortedRecords) {
                const prevPoints = cumulativePoints;
                const prevJudgeCount = judges.size;
                
                cumulativePoints += record.points;
                if (record.judge) judges.add(record.judge);
                
                const nowHasTitle = cumulativePoints >= 4 && judges.size >= 2;
                const previouslyHadTitle = prevPoints >= 4 && prevJudgeCount >= 2;
                
                if (nowHasTitle && !previouslyHadTitle) {
                    return {
                        titlePoints: Math.min(4, prevPoints + record.points),
                        titleDate: record.date
                    };
                }
            }
            
            return {
                titlePoints: cumulativePoints,
                titleDate: sortedRecords[sortedRecords.length - 1]?.date
            };
        }

        function showLevelDetails(level, dogName) {
            const records = currentDogRecords.filter(r => r.level === level);
            
            document.getElementById('modalTitle').textContent = `${dogName} - ${level} Details`;
            
            let html = `
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Judge</th>
                            <th>Results</th>
                            <th>Q's</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            records.sort((a, b) => new Date(a.date) - new Date(b.date));

            records.forEach(record => {
                const date = record.date && record.date instanceof Date && !isNaN(record.date) 
                    ? record.date.toLocaleDateString() 
                    : 'N/A';
                const pointsClass = record.points > 0 ? 'points-badge' : 'points-badge zero';
                
                html += `
                    <tr>
                        <td>${date}</td>
                        <td>${record.judge || 'N/A'}</td>
                        <td>${record.results || 'N/A'}</td>
                        <td><span class="${pointsClass}">${record.points}</span></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('detailsModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        function loadDataFromFile() {
            const timeoutId = setTimeout(() => {
                showFileUpload();
            }, 3000);

            fetch('Data for Tracker web.xlsx')
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.arrayBuffer();
                })
                .then(data => {
                    processExcelData(new Uint8Array(data));
                    updateLastUpdatedDate();
                    document.getElementById('summaryContent').innerHTML = `
                        <div class="validation-rules">
                            <h4>Title Requirements</h4>
                            <ul>
                                <li>Minimum 4 Q's required for each level</li>
                                <li>Q's must come from at least 2 different judges</li>
                                <li>Prerequisites must be met before advancing to higher levels</li>
                                <li>Special case: "Investigator 3" requires either "Patrol 1" OR "Detective 2"</li>
                                <li>Games levels require at least 2 different games (BJ, C, P, T, GB)</li>
                                <li>Ace awards given every 10 Q's after title is earned</li>
                            </ul>
                        </div>
                    `;
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    document.getElementById('lastUpdated').textContent = 'File not found';
                    showFileUpload();
                });
        }

        function showFileUpload() {
            document.getElementById('summaryContent').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h3 style="color: #17a2b8; margin-bottom: 20px;">üìÅ Upload Data File</h3>
                    <p style="margin-bottom: 20px;">Select your Excel file to load the trialing data:</p>
                    
                    <div style="background: #f8f9fa; padding: 30px; border-radius: 12px; border: 2px dashed #dee2e6; margin: 20px 0;">
                        <input type="file" id="manualDataFile" accept=".xlsx,.xls,.csv" style="margin-bottom: 15px;">
                        <br>
                        <button onclick="loadManualFile()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                            üì§ Load File
                        </button>
                    </div>
                    
                    <button onclick="loadDataFromFile()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; margin-top: 15px;">
                        ‚Üê Try Auto-Loading Again
                    </button>
                </div>
            `;
        }

        function loadManualFile() {
            const fileInput = document.getElementById('manualDataFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file first');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    processExcelData(data);
                    updateLastUpdatedDate();
                    document.getElementById('summaryContent').innerHTML = `
                        <div class="validation-rules">
                            <h4>Title Requirements</h4>
                            <ul>
                                <li>Minimum 4 Q's required for each level</li>
                                <li>Q's must come from at least 2 different judges</li>
                                <li>Prerequisites must be met before advancing to higher levels</li>
                                <li>Special case: "Investigator 3" requires either "Patrol 1" OR "Detective 2"</li>
                                <li>Games levels require at least 2 different games (BJ, C, P, T, GB)</li>
                                <li>Ace awards given every 10 Q's after title is earned</li>
                            </ul>
                        </div>
                    `;
                    alert(`Successfully loaded ${trialingData.length} records!`);
                } catch (error) {
                    alert(`Error loading file: ${error.message}`);
                }
            };
            
            reader.onerror = function() {
                alert('Error reading file. Please try again.');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function processExcelData(data) {
            const workbook = XLSX.read(data, {type: 'array', cellDates: true});
            const dataSheet = workbook.Sheets['Data'] || workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(dataSheet, {header: 1, dateNF: 'yyyy-mm-dd'});
            
            trialingData = jsonData.slice(1).map(row => {
                let processedDate = row[2];
                
                if (typeof processedDate === 'number') {
                    processedDate = XLSX.SSF.parse_date_code(processedDate);
                    processedDate = new Date(processedDate.y, processedDate.m - 1, processedDate.d);
                } else if (typeof processedDate === 'string') {
                    processedDate = new Date(processedDate);
                } else if (processedDate instanceof Date) {
                    processedDate = processedDate;
                } else {
                    processedDate = null;
                }
                
                return {
                    registrationNumber: row[0],
                    callName: row[1],
                    date: processedDate,
                    level: row[3],
                    results: row[4],
                    judge: row[5],
                    points: parseFloat(row[6]) || 0
                };
            }).filter(record => record.registrationNumber && record.level);
        }

        function updateLastUpdatedDate() {
            if (trialingData.length === 0) {
                document.getElementById('lastUpdated').textContent = 'No data available';
                return;
            }

            const validDates = trialingData
                .map(record => record.date)
                .filter(date => date instanceof Date && !isNaN(date))
                .sort((a, b) => b - a);

            if (validDates.length > 0) {
                const mostRecentDate = validDates[0];
                document.getElementById('lastUpdated').textContent = 
                    `Last updated: ${mostRecentDate.toLocaleDateString()}`;
            } else {
                document.getElementById('lastUpdated').textContent = 'Last updated: Unknown';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('lastUpdated').textContent = 'Loading data...';
            setTimeout(() => {
                loadDataFromFile();
            }, 100);
        });

        window.onclick = function(event) {
            const modal = document.getElementById('detailsModal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>